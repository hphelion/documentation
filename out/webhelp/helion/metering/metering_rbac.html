
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="Role Base Access Control (RBAC) is a technique that limits access to resources based on a specific set of role(s) associated with each user's credentials. Keystone has a set of users that are ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="DC.Type" content="topic"></meta><meta name="DC.Title" content="HPE Helion OpenStack 2.0: Ceilometer Metering Setting Role-based Access Control"></meta><meta name="prodname" content="HPE Helion"></meta><meta name="version" content="4.1.0"></meta><meta name="copyright" content="HPE Helion 2015" type="primary"></meta><meta name="DC.Rights.Owner" content="HPE Helion 2015" type="primary"></meta><meta name="layout" content="default"></meta><meta name="product-version" content="HPE Helion Openstack"></meta><meta name="product-version" content="HPE Helion Openstack 1.1"></meta><meta name="product-version1" content="HPE Helion Openstack"></meta><meta name="product-version2" content="HPE Helion Openstack 1.1"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="topic15050"></meta><meta name="DC.Language" content="en-us"></meta><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>HPE Helion OpenStack 2.0: Ceilometer Metering Setting Role-based Access Control</title><!--  Generated with Oxygen version 17.0, build number 2015072912.  --><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "../../index.html";
          
          --></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="../../oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="topic15050">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"></td><td><div class="navheader"></div></td></tr></tbody></table>

  <h1 class="title topictitle1">HPE Helion OpenStack<sup>Â®</sup> 2.0: Ceilometer Metering Setting Role-based
    Access Control</h1>

  
  <div class="body">
  
    <p class="p">Role Base Access Control (RBAC) is a technique that limits access to resources based on a
      specific set of role(s) associated with each user's credentials.</p>

    <p class="p">Keystone has a set of users that are associated with each project. Each user has one or more
      roles. After a user has authenticated with Keystone using a valid set of credentials,
      typically User Name and Password or Token, Keystone will augment that request with the Roles
      that are associated with that user. These roles are added to the Request Header under the
      X-Roles attribute and are presented as a comma-separated list.</p>

    <ul class="ul">
      <li class="li">
        <a class="xref" href="#topic15050__display_users">Displaying All Users</a>
      </li>

      <li class="li">
        <a class="xref" href="#topic15050__display_roles">Displaying All Roles</a>
      </li>

      <li class="li">
        <a class="xref" href="#topic15050__assign_role">Assigning a Role to a User</a>
      </li>

      <li class="li">
        <a class="xref" href="#topic15050__create_role">Creating a New Role</a>
      </li>

      <li class="li">
        <a class="xref" href="#topic15050__access_policies">Ceilometer Access Policies</a>
        <ul class="ul">
          <li class="li">
            <a class="xref" href="#topic15050__newfile">New RBAC Policy File</a>
          </li>

          <li class="li">
            <a class="xref" href="#topic15050__apply_policy">Applying Policies to Roles</a>
          </li>

          <li class="li">
            <a class="xref" href="#topic15050__write_policy">Writing a Policy</a>
          </li>

        </ul>

      </li>

    </ul>

    <div class="section" id="topic15050__display_users"><h2 class="title sectiontitle">Displaying All Users</h2>
      
      <p class="p">To discover the list of users available in the system, an administrator can run the
        following command using the Keystone command-line interface:</p>

      <pre class="pre codeblock">keystone user-list</pre>

      <p class="p">The output should resemble this response, which is a list of all the users currently
        available in this system.</p>

      <pre class="pre codeblock">+----------------------------------+-----------------------------------------+----+
|                id                |    name      | enabled |       email        |
+----------------------------------+-----------------------------------------+----+
| 1c20d327c92a4ea8bb513894ce26f1f1 |   admin      |   True  | admin.example.com  |
| 0f48f3cc093c44b4ad969898713a0d65 | ceilometer   |   True  | nobody@example.com |
| 85ba98d27b1c4c8f97993e34fcd14f48 |   cinder     |   True  | nobody@example.com |
| d2ff982a0b6547d0921b94957db714d6 |    demo      |   True  |  demo@example.com  |
| b2d597e83664489ebd1d3c4742a04b7c |    ec2       |   True  | nobody@example.com |
| 99afb00e498a487eb83c96c9bd209586 |    gf1       |   True  |   gf@helion.com    |
| 42d13c0df38a47989639b5fe99976f26 |    gf2       |   True  |   gf@helion.com    |
| 2b95b2600dc741958eae15057ff7e89b |    gf3       |   True  |   gf@helion.com    |
| 2bd85070ceec4b608d9f1b06c6be22cb |   glance     |   True  | nobody@example.com |
| 0e9e2daebbd3464097557b87af4afa4c |    heat      |   True  | nobody@example.com |
| 9f7fd03c90904d83ae73ef1b40a6baf0 |    jaq1      |   True  |   jaq@helion.com   |
| 7a73e59a100342099c59278a392f582a |    jaq2      |   True  |   jaq@helion.com   |
| 72e404eab90f41c6a181b9602e0fa777 |    jaq3      |   True  |   jaq@helion.com   |
| b149fe9c5f0e421e8349efc52f4b0451 |    jaq4      |   True  |   jaq@helion.com   |
| 0e54dab3c76349c5ab50f196a979b4c0 |    jaq5      |   True  |   jaq@helion.com   |
| 0b466ddc2c0f478aa139d2a0be314467 |  neutron     |   True  | nobody@example.com |
| 5cda1a541dee4555aab88f36e5759268 |    nova      |   True  | nobody@example.com |
| 6ae85dff35e14c3d878c202b6277362f |   sherpa     |   True  | nobody@example.com |
| 1cefd1361be8437d9684eb2add8bdbfa |   swift      |   True  | nobody@example.com |
| f05bac3532c44414a26c0086797dab23 | user20141203213957|True| nobody@example.com |
| 3db0588e140d4f88b0d4cc8b5ca86a0b | user20141205232231|True| nobody@example.com |
+----------------------------------+-----------------------------------------+----+</pre>

    </div>

    <div class="section" id="topic15050__display_roles"><h2 class="title sectiontitle">Displaying All Roles</h2>
      
      <p class="p">To see all the roles that are currently available in the deployment, an administrator
        (someone with the admin role) can run the following command:</p>

      <pre class="pre codeblock">keystone role-list</pre>

      <p class="p">The output should resemble the following response:</p>

      <pre class="pre codeblock">+----------------------------------+-------------------------------------+
|                id                |                 name                |
+----------------------------------+-------------------------------------+
| 507bface531e4ac2b7019a1684df3370 |            ResellerAdmin            |
| 9fe2ff9ee4384b1894a90878d3e92bab |               _member_              |
| e00e9406b536470dbde2689ce1edb683 |                admin                |
| aa60501f1e664ddab72b0a9f27f96d2c |           heat_stack_user           |
| a082d27b033b4fdea37ebb2a5dc1a07b |               service               |
| 8f11f6761534407585feecb5e896922f |            swiftoperator            |
+----------------------------------+-------------------------------------+</pre>

    </div>

    <div class="section" id="topic15050__assign_role"><h2 class="title sectiontitle">Assigning a Role to a User</h2>
      
      <p class="p">In this example, we want to add the role <strong class="ph b">ResellerAdmin</strong> to the demo user who has the
        ID <strong class="ph b">d2ff982a0b6547d0921b94957db714d6</strong>.</p>

      <ol class="ol">
        <li class="li">Determine which Project/Tenant the user belongs
            to.<pre class="pre codeblock">keystone user-get d2ff982a0b6547d0921b94957db714d6</pre>
<p class="p">The
            response should resemble the following
          output:</p>
<pre class="pre codeblock">+----------+----------------------------------+
| Property |              Value               |
+----------+----------------------------------+
|  email   |         demo@example.com         |
| enabled  |               True               |
|    id    | d2ff982a0b6547d0921b94957db714d6 |
|   name   |               demo               |
| username |               demo               |
+----------+----------------------------------+</pre>
</li>

        <li class="li">We need to link the ResellerAdmin Role to a Project/Tenant. To start, determine which
          tenants are available on this
            deployment.<pre class="pre codeblock">keystone tenant-list</pre>
<p class="p">The
            response should resemble the following
          output:</p>
<pre class="pre codeblock">+----------------------------------+-------------------------------+--+
|                id                |        name       | enabled |
+----------------------------------+-------------------------------+--+
| 4a8f4207a13444089a18dc524f41b2cf |       admin       |   True  |
| 00cbaf647bf24627b01b1a314e796138 |        demo       |   True  |
| 8374761f28df43b09b20fcd3148c4a08 |        gf1        |   True  |
| 0f8a9eef727f4011a7c709e3fbe435fa |        gf2        |   True  |
| 6eff7b888f8e470a89a113acfcca87db |        gf3        |   True  |
| f0b5d86c7769478da82cdeb180aba1b0 |        jaq1       |   True  |
| a46f1127e78744e88d6bba20d2fc6e23 |        jaq2       |   True  |
| 977b9b7f9a6b4f59aaa70e5a1f4ebf0b |        jaq3       |   True  |
| 4055962ba9e44561ab495e8d4fafa41d |        jaq4       |   True  |
| 33ec7f15476545d1980cf90b05e1b5a8 |        jaq5       |   True  |
| 9550570f8bf147b3b9451a635a1024a1 |      service      |   True  |
+----------------------------------+-------------------------------+--+</pre>
</li>

        <li class="li">Now that we have all the pieces, we can assign the ResellerAdmin role to this User on
          the Demo
            project.<pre class="pre codeblock">keystone user-role-add --user-id d2ff982a0b6547d0921b94957db714d6 --role-id 507bface531e4ac2b7019a1684df3370 --tenant-id 00cbaf647bf24627b01b1a314e796138</pre>
<p class="p">This
            will produce no response if everything is correct.</p>
</li>

        <li class="li">Validate that the role has been assigned correctly. Pass in the user and tenant ID and
          request a list of roles
            assigned.<pre class="pre codeblock">keystone user-role-list --user-id d2ff982a0b6547d0921b94957db714d6 --tenant-id 00cbaf647bf24627b01b1a314e796138</pre>
<p class="p">Note
            that all members have the <em class="ph i">_member_</em> role as a default role in addition to any
            other roles that have been
          assigned.</p>
<pre class="pre codeblock">+----------------------------------+---------------+----------------------------------+----------------------------------+
|                id                |      name     |             user_id              | tenant_id             |
+----------------------------------+---------------+----------------------------------+----------------------------------+
| 507bface531e4ac2b7019a1684df3370 | ResellerAdmin | d2ff982a0b6547d0921b94957db714d6 | 00cbaf647bf24627b01b1a314e796138 |
| 9fe2ff9ee4384b1894a90878d3e92bab |    _member_   | d2ff982a0b6547d0921b94957db714d6 | 00cbaf647bf24627b01b1a314e796138 |
+----------------------------------+---------------+----------------------------------+----------------------------------+</pre>
</li>

      </ol>

    </div>

    <div class="section" id="topic15050__create_role"><h2 class="title sectiontitle">Creating a New Role</h2>
      
      <p class="p">In this example, we will create a Level 3 Support role called <strong class="ph b">L3Support</strong>.</p>

      <ol class="ol">
        <li class="li">Add the new role to the list of
            roles.<pre class="pre codeblock">keystone role-create --name L3Support</pre>
<p class="p">The
            response should resemble the following
          output:</p>
<pre class="pre codeblock">+----------+----------------------------------+
| Property |              Value               |
+----------+----------------------------------+
|    id    | 7e77946db05645c4ba56c6c82bf3f8d2 |
|   name   |            L3Support             |
+----------+----------------------------------+</pre>
</li>

        <li class="li">Now that we have the new role's ID, we can add that role to the Demo user from the
          previous
            example.<pre class="pre codeblock">keystone user-role-add --user-id d2ff982a0b6547d0921b94957db714d6 --role-id 7e77946db05645c4ba56c6c82bf3f8d2 --tenant-id 00cbaf647bf24627b01b1a314e796138</pre>
<p class="p">This
            will produce no response if everything is correct.</p>
</li>

        <li class="li">Verify that the user Demo has both the ResellerAdmin and L3Support
          roles.<pre class="pre codeblock">keystone user-role-list --user-id d2ff982a0b6547d0921b94957db714d6 --tenant-id 00cbaf647bf24627b01b1a314e796138</pre>
</li>

        <li class="li">The response should resemble the following output. Note that this user has the L3Support
          role, the ResellerAdmin role, and the default member
          role.<pre class="pre codeblock">+----------------------------------+---------------+----------------------------------+----------------------------------+
|                id                |      name     |             user_id              |            tenant_id             |
+----------------------------------+---------------+----------------------------------+----------------------------------+
| 7e77946db05645c4ba56c6c82bf3f8d2 |   L3Support   | d2ff982a0b6547d0921b94957db714d6 | 00cbaf647bf24627b01b1a314e796138 |
| 507bface531e4ac2b7019a1684df3370 | ResellerAdmin | d2ff982a0b6547d0921b94957db714d6 | 00cbaf647bf24627b01b1a314e796138 |
| 9fe2ff9ee4384b1894a90878d3e92bab |    _member_   | d2ff982a0b6547d0921b94957db714d6 | 00cbaf647bf24627b01b1a314e796138 |
+----------------------------------+---------------+----------------------------------+----------------------------------+</pre>
</li>

      </ol>

    </div>

    <div class="section" id="topic15050__access_policies"><h2 class="title sectiontitle">Access Policies</h2>
      
      <p class="p">Before introducing RBAC, Ceilometer had very simple access control. There were two types of
        user: admins and users. Admins will be able to access any API and perform any operation.
        Users will only be able to access non-admin APIs and perform operations only on the
        Project/Tenant where they belonged.</p>

    </div>

    <div class="section" id="topic15050__newfile"><h2 class="title sectiontitle">New RBAC Policy File</h2>
      
      <p class="p">This is the policy file for Ceilometer without RBAC (<strong class="ph b">etc/ceilometer/policy.json</strong>)</p>

      <pre class="pre codeblock">{
  "context_is_admin": "role:admin"
}</pre>

      <p class="p">With the RBAC-enhanced code it is possible to control access to each API command. The new
        policy file (<em class="ph i">rbac_policy.json</em>) looks like this.</p>

      <pre class="pre codeblock">{
    "context_is_admin": "role:admin",
    "telemetry:get_samples": "rule:context_is_admin",
    "telemetry:get_sample": "rule:context_is_admin",
    "telemetry:query_sample": "rule:context_is_admin",
    "telemetry:create_samples": "rule:context_is_admin",
    "telemetry:compute_statistics": "rule:context_is_admin",
    "telemetry:get_meters": "rule:context_is_admin",
    "telemetry:get_resource": "rule:context_is_admin",
    "telemetry:get_resources": "rule:context_is_admin",
    "telemetry:get_alarm": "rule:context_is_admin",
    "telemetry:query_alarm": "rule:context_is_admin",
    "telemetry:get_alarm_state": "rule:context_is_admin",
    "telemetry:get_alarms": "rule:context_is_admin",
    "telemetry:create_alarm": "rule:context_is_admin",
    "telemetry:set_alarm": "rule:service_role",
    "telemetry:delete_alarm": "rule:context_is_admin",
    "telemetry:alarm_history": "rule:context_is_admin",
    "telemetry:change_alarm_state": "rule:context_is_admin",
    "telemetry:query_alarm_history": "rule:context_is_admin"
}</pre>

      <p class="p">Note that the API action names are namespaced using the <strong class="ph b">telemetry:</strong> prefix. This
        avoids potential confusion if other services have policies with the same name.</p>

    </div>

    <div class="section" id="topic15050__apply_policy"><h2 class="title sectiontitle">Applying Policies to Roles</h2>
      
      <p class="p">Copy the <strong class="ph b">rbac_policy.json</strong> file over the <strong class="ph b">policy.json</strong> file and make any
        required changes.</p>

    </div>

    <div class="section" id="topic15050__apply-a-policy-to-multiple-roles"><h2 class="title sectiontitle">Apply a policy to multiple roles</h2>
      
      <p class="p">For example, the ResellerAdmin role could also be permitted to access
          <strong class="ph b">compute_statistics</strong>. This change would require the following changes in the
          <strong class="ph b">rbac_policy.json</strong> policy file:</p>

      <pre class="pre codeblock">{
    "context_is_admin": "role:admin",
    "i_am_reseller": "role:ResellerAdmin",
    "telemetry:get_samples": "rule:context_is_admin",
    "telemetry:get_sample": "rule:context_is_admin",
    "telemetry:query_sample": "rule:context_is_admin",
    "telemetry:create_samples": "rule:context_is_admin",
    "telemetry:compute_statistics": "rule:context_is_admin or rule:i_am_reseller",
    ...
}</pre>

      <p class="p">After a policy change has been made all the API services will need to be <a class="xref" href="metering_components.html#topic4362__centralagent">restarted</a>.</p>

    </div>

    <div class="section" id="topic15050__apply-a-policy-to-a-non-default-role-only"><h2 class="title sectiontitle">Apply a policy to a non-default role only</h2>
      
      <p class="p">Another example: assign the L3Support role to the <strong class="ph b">get_meters</strong> API and exclude all
        other roles.</p>

      <pre class="pre codeblock">{
    "context_is_admin": "role:admin",
    "i_am_reseller": "role:ResellerAdmin",
    "l3_support": "role:L3Support",
    "telemetry:get_samples": "rule:context_is_admin",
    "telemetry:get_sample": "rule:context_is_admin",
    "telemetry:query_sample": "rule:context_is_admin",
    "telemetry:create_samples": "rule:context_is_admin",
    "telemetry:compute_statistics": "rule:context_is_admin or rule:i_am_reseller",
    "telemetry:get_meters": "rule:l3_support",
    ...
}</pre>

    </div>

    <div class="section" id="topic15050__write_policy"><h2 class="title sectiontitle">Writing a Policy</h2>
      
      <p class="p">The Policy Engine capabilities are as expressible using a set of rules and guidelines. For
        a complete reference, please see the <a class="xref" href="https://github.com/openstack/oslo.policy/blob/master/oslo_policy/policy.py" target="_blank">OSLO policy documentation</a>.</p>

      <p class="p">Policies can be expressed in one of two forms: A list of lists, or a string written in the
        new policy language.</p>

      <p class="p">In the list-of-lists representation, each check inside the innermost list is combined with
        an <strong class="ph b">and</strong> conjunction - for that check to pass, <strong class="ph b">all</strong> the specified checks must
        pass. These innermost lists are then combined as with an <strong class="ph b">or</strong> conjunction.</p>

      <p class="p">As an example, take the following rule, expressed in the list-of-lists representation:</p>

      <pre class="pre codeblock">[["role:admin"], ["project_id:%(project_id)s", "role:projectadmin"]]</pre>

      <p class="p">In the policy language, each check is specified the same way as in the list-of-lists
        representation: a simple [a:b] pair that is matched to the correct class to perform that
        check.</p>

      <ul class="ul">
        <li class="li">
          <p class="p">User's Role</p>

          <pre class="pre codeblock">role:admin</pre>

        </li>

        <li class="li">
          <p class="p">Rules already defined on policy</p>

          <pre class="pre codeblock">rule:admin_required</pre>

        </li>

        <li class="li">
          <p class="p">Against a URL (URL checking must return TRUE to be valid)</p>

          <pre class="pre codeblock">http://my-url.org/check</pre>

        </li>

        <li class="li">
          <p class="p">User attributes (obtained through the token: user_id, domain_id, project_id)</p>

          <pre class="pre codeblock">project_id:%(target.project.id)s</pre>

        </li>

        <li class="li">
          <p class="p">Strings</p>

          <pre class="pre codeblock">&lt;variable&gt;:'xpto2035abc'
'myproject':&lt;variable&gt;</pre>

        </li>

        <li class="li">
          <p class="p">Literals</p>

          <pre class="pre codeblock">project_id:xpto2035abc
domain_id:20
True:%(user.enabled)s</pre>

        </li>

      </ul>

      <p class="p">Conjunction operators are also available, allowing for more flexibility in crafting
        policies. So, in the policy language, the previous check in list-of-lists becomes:</p>

      <pre class="pre codeblock">role:admin or (project_id:%(project_id)s and role:projectadmin)</pre>

      <p class="p">The policy language also has the NOT operator, allowing for richer policy rules:</p>

      <pre class="pre codeblock">project_id:%(project_id)s and not role:dunce</pre>

      <p class="p">Attributes sent along with API calls can be used by the policy engine (on the right side of
        the expression), by using the following syntax:</p>

      <pre class="pre codeblock">&lt;some_value&gt;:%(user.id)s</pre>

      <p class="p">
        <strong class="ph b">Note</strong>: two special policy checks should be mentioned; the policy check <strong class="ph b">@</strong> will
          <strong class="ph b">always accept</strong> an access, and the policy check <strong class="ph b">!</strong> will <strong class="ph b">always reject</strong> an
        access.</p>

    </div>

  </div>

<div class="navfooter"><!----></div><div class="footer">WebHelp output generated by<a class="oxyFooter" href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="../../oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a></div>
</body>
</html>