
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="Integrating with an external LDAP server If your organization, like most, uses an LDAP directory service such as Active Directory, you can integrate it with Keystone by following the steps outlined ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="DC.Type" content="topic"></meta><meta name="DC.Title" content="HPE Helion OpenStack 2.0: Integrating LDAP with the Identity Service"></meta><meta name="prodname" content="HPE Helion"></meta><meta name="version" content="4.1.0"></meta><meta name="copyright" content="HPE Helion 2015" type="primary"></meta><meta name="DC.Rights.Owner" content="HPE Helion 2015" type="primary"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="topic_ifg_n33_bt"></meta><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>HPE Helion OpenStack 2.0: Integrating LDAP with the Identity Service</title><!--  Generated with Oxygen version 17.0, build number 2015072912.  --><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "../../index.html";
          
          --></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="../../oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="topic_ifg_n33_bt">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"></td><td><div class="navheader"></div></td></tr></tbody></table>

  <h1 class="title topictitle1">HPE Helion OpenStack<sup>Â®</sup> 2.0: Integrating LDAP with the Identity
    Service</h1>

  <div class="body">
    <div class="section"><h2 class="title sectiontitle">Integrating with an external LDAP server</h2>
      <p class="p">If your organization, like most, uses an LDAP directory service such as Active Directory,
        you can integrate it with Keystone by following the steps outlined below.</p>

      <p class="p">Integration with an external LDAP server is supported via the Keystone domain-specific
        configuration.</p>

      <ol class="ol">
        <li class="li">Ensure that the <samp class="ph codeph">domain_specific_drivers_enabled</samp> option is set to
            <samp class="ph codeph">True</samp> in the main configuration file template in this file:
          <pre class="pre codeblock">/home/stack/helion/my_cloud/config/keystone/keystone.conf.j2</pre>
</li>

        <li class="li">Create a YAML file which contains the definition of the LDAP server connection. The
          sample file below is already provided as part of the lifecycle-managers <a class="xref" href="../installation/using_git.html#using_git">local git repository</a>. It is
          available on a deployer/lifecycle-manager node in the following file:
          <pre class="pre codeblock">/home/stack/helion/my_cloud/config/keystone/keystone_configure_ldap_sample.yml</pre>
.
            <p class="p">Save a copy of this file with a new name, for example:</p>

          <pre class="pre codeblock">/home/stack/helion/my_cloud/config/keystone/keystone_configure_ldap_my.yml</pre>

          <div class="note note"><span class="notetitle">Note:</span> Please refer to [ldap] section of the <a class="xref" href="http://docs.openstack.org/kilo/config-reference/content/keystone-configuration-file.html" target="_blank">Keystone</a> documentation for OpenStack Kilo for
            the full option list and description.</div>

          <p class="p">Here is the sample YAML configuration, optimized for Microsoft Active Directory
            server:</p>

          <pre class="pre codeblock">---
 
keystone_domainldap_conf:
 
    # CA certificates file content.
    # Certificates are stored in Base64 PEM format. This may be entire LDAP server
    # certificate (in case of self-signed certificates), certificate of authority 
    # which issued LDAP server certificate, or a full certificate chain (Root CA
    # certificate, intermediate CA certificate(s), issuer certificate).
    #
    cert_settings:
      cacert: |
        -----BEGIN CERTIFICATE-----
 
        certificate appears here
 
        -----END CERTIFICATE-----
 
    # A domain will be created in MySQL with this name, and associated with ldap backend.
    # Installer will also generate a config file named /etc/keystone/domains/keystone.&lt;domain_name&gt;.conf
    #
    domain_settings:
      name: dept1
      description: Dedicated domain for dept1 users
 
    conf_settings:
      identity:
         driver: keystone.identity.backends.ldap.Identity
 
      assignment:
        driver: keystone.assignment.backends.sql.Assignment
 
      # For full list and description of ldap configuration options, please refer to
      # https://github.com/openstack/keystone/blob/master/etc/keystone.conf.sample or
      # http://docs.openstack.org/kilo/config-reference/content/keystone-configuration-file.html.
      #
      # Please note:
      #  1. LDAP configuration is read-only. Configuration which performs write operations (i.e. creates users, groups, etc)
      #     is not supported at the moment.
      #  2. LDAP is only supported for identity operations (reading users and groups from LDAP). Assignment
      #     operations with LDAP (i.e. managing roles, projects) are not supported.
      #  3. LDAP is configured as non-default domain. Configuring LDAP as a default domain is not supported.
      #
      ldap:
        url: ldap://ad.myorg.com
        suffix: DC=acme,DC=net
        user_tree_dn: CN=Users,DC=acme,DC=net
        user : CN=admin,CN=Users,DC=acme,DC=net
        password: REDACTED
        user_objectclass: user
        user_id_attribute: cn
        user_name_attribute: cn
        user_allow_create: False
        user_allow_update: False
        user_allow_delete: False
        group_tree_dn: CN=Users,DC=acme,DC=net
        group_objectclass: group
        group_id_attribute: cn
        group_name_attribute: cn
        group_allow_create: False
        group_allow_update: False
        group_allow_delete: False
        use_pool: True
        user_enabled_attribute: userAccountControl
        user_enabled_mask: 2
        user_enabled_default: 512
        use_tls: True
       tls_req_cert: demand
        # if you are configuring multiple LDAP domains, and LDAP server certificates are issued
        # by different authorities, make sure that you place certs for all the LDAP backend domains in the 
        # cacert parameter as seen in this sample yml file so that all the certs are combined in a single CA file 
        # and every LDAP domain configuration points to the combined CA file.
        # Note: There is a known issue on one cert per CA file per domain when the system processes 
        # concurrent requests to multiple LDAP domains. Using the single CA file with all certs combined 
        # shall get the system working properly*.
        # The issue is in the underlying SSL library. Upstream is not investing in python-ldap package anymore. It is also not python3
        # compliant. At <a class="xref" href="https://etherpad.openstack.org/p/keystone-mitaka-summit-brainstorm" target="_blank">Mitaka summit</a>, we will be proposing a transition off python-ldap to use python3-ldap.
        
        tls_cacertfile: /etc/keystone/ssl/certs/all_ldapca.pem</pre>

        </li>

        <li class="li">As suggested at <a class="xref" href="../installation/using_git.html#using_git">Using Git for
            Configuration Management</a>, commit the new file into local git repository, and
          rerun configuration processor / deployment area preparation playbooks :
          <pre class="pre codeblock">$ cd ~/helion
$ git checkout site
$ git add my_cloud/config/keystone/keystone_configure_ldap_my.yml
$ git commit -m "Adding LDAP server integration config"
$ cd ~/helion/hos/ansible
$ ansible-playbook -i hosts/localhost config-processor-run.yml
$ ansible-playbook -i hosts/localhost ready-deployment.yml</pre>

        </li>

        <li class="li"> Run reconfiguration playbook in a deployment area, passing a YAML file created at
          previous step as command line option:
          <pre class="pre codeblock">$ cd ~/scratch/ansible/next/hos/ansible
$ ansible-playbook -i hosts/verb_hosts keystone-reconfigure.yml -e@/home/stack/helion/my_cloud/config/keystone/keystone_configure_ldap_my.yml</pre>

        </li>

        <li class="li"> Follow these same steps for each LDAP domain with which you are integrating Keystone,
          creating a yaml file for each and running the reconfigure playbook once for each
          additional domain. </li>

        <li class="li">Ensure that a new domain was created for LDAP (Microsoft AD in this example): <pre class="pre codeblock"># Set environment variables for admin level access
$ source keystone.osrc
 
# Get list of domains
$ openstack domain list
+----------------------------------+---------+---------+----------------------------------------------------------------------+
| ID                               | Name    | Enabled | Description                                                          |
+----------------------------------+---------+---------+----------------------------------------------------------------------+
| 6740dbf7465a4108a36d6476fc967dbd | heat    | True    | Owns users and projects created by heat                              |
| default                          | Default | True    | Owns users and tenants (i.e. projects) available on Identity API v2. |
| b2aac984a52e49259a2bbf74b7c4108b | ad      | True    | Dedicated domain for users managed by Microsoft AD server            |
+----------------------------------+---------+---------+----------------------------------------------------------------------+
 
# Get list of LDAP groups
$ openstack group list --domain ad
+------------------------------------------------------------------+------------+
| ID                                                               | Name       |
+------------------------------------------------------------------+------------+
| 03976b0ea6f54a8e4c0032e8f756ad581f26915c7e77500c8d4aaf0e83afcdc6 | testgroup1 |
| 7ba52ee1c5829d9837d740c08dffa07ad118ea1db2d70e0dc7fa7853e0b79fcf | testgroup2 |
+------------------------------------------------------------------+------------+</pre>

          <div class="note note"><span class="notetitle">Note:</span> LDAP domain is read-only. This means that you can not create new user or group
            record in it.</div>

        </li>

        <li class="li"> Once LDAP user is granted appropriate role, it can authenticate within specified
          domain:
          <pre class="pre codeblock"># Set environment variables for admin level access
$ source keystone.osrc
 
# Get user record within ad domain
$ openstack user show testuser1 --domain ad
+-----------+------------------------------------------------------------------+
| Field     | Value                                                            |
+-----------+------------------------------------------------------------------+
| domain_id | 143af847018c4dc7bd35390402395886                                 |
| id        | e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 |
| name      | testuser1                                                        |
+-----------+------------------------------------------------------------------+
 
# Create a new role. Please note that role is not bound to domain.
$ openstack role create testrole1
+-------+----------------------------------+
| Field | Value                            |
+-------+----------------------------------+
| id    | 02251585319d459ab847409dea527dee |
| name  | testrole1                        |
+-------+----------------------------------+
 
# Grant user a role within domain. Please note that due to current Openstack CLI limitation, we have to use user ID rather then user name
# when working with non-default domain.
$ openstack role add testrole1 --user e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 --domain ad
 
# Verify if role was successfully granted
$ openstack role assignment list --user e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 --domain ad
+----------------------------------+------------------------------------------------------------------+-------+---------+----------------------------------+
| Role                             | User                                                             | Group | Project | Domain                           |
+----------------------------------+------------------------------------------------------------------+-------+---------+----------------------------------+
| 02251585319d459ab847409dea527dee | e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 |       |         | 143af847018c4dc7bd35390402395886 |
+----------------------------------+------------------------------------------------------------------+-------+---------+----------------------------------+
 
# Authenticate (get a domain-scoped token) as new user with a new role. The --os-* command line parameters specified below override respective OS_* environment
# variables set by keystone.osrc script to provide admin access. To ensure that command below is executed in clean environment, you may want log out from
# the node and log in again. 
$ openstack --os-identity-api-version 3 \
            --os-username testuser1 \
            --os-password testuser1_password \
            --os-auth-url http://10.0.0.6:35357/v3 \
            --os-domain-name ad \
            --os-user-domain-name ad \
            token issue
+-----------+------------------------------------------------------------------+
| Field     | Value                                                            |
+-----------+------------------------------------------------------------------+
| domain_id | 143af847018c4dc7bd35390402395886                                 |
| expires   | 2015-09-09T21:36:15.306561Z                                      |
| id        | 6f8f9f1a932a4d01b7ad9ab061eb0917                                 |
| user_id   | e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 |
+-----------+------------------------------------------------------------------+</pre>

        </li>


        <li class="li">Users can also have a project within domain and get a project-scoped token:
          <pre class="pre codeblock"># Set environment variables for admin level access
$ source keystone.osrc
 
# Create a new project within domain
$ openstack project create testproject1 --domain ad
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description |                                  |
| domain_id   | 143af847018c4dc7bd35390402395886 |
| enabled     | True                             |
| id          | d065394842d34abd87167ab12759f107 |
| name        | testproject1                     |
+-------------+----------------------------------+
 
# Grant user a role with a project, re-using a role created in previous example.  Please note that due to current Openstack CLI limitation, we have to use
# user ID rather then user name when working with non-default domain.
$ openstack role add testrole1 --user e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 --project testproject1
 
# Verify if role was successfully granted
$ openstack role assignment list --user e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 --project testproject1
+----------------------------------+------------------------------------------------------------------+-------+----------------------------------+--------+
| Role                             | User                                                             | Group | Project                          | Domain |
+----------------------------------+------------------------------------------------------------------+-------+----------------------------------+--------+
| 02251585319d459ab847409dea527dee | e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 |       | d065394842d34abd87167ab12759f107 |        |
+----------------------------------+------------------------------------------------------------------+-------+----------------------------------+--------+
 
# Authenticate (get a project-scoped token) as new user with a new role. The --os-* command line parameters specified below override respective OS_* environment
# variables set by keystone.osrc script to provide admin access. To ensure that command below is executed in clean environment, you may want log out from
# the node and log in again. Please note that both --os-project-domain-name and --os-project-user-name parameters are needed to justify that both user and
# project are not in default domain.
$ openstack --os-identity-api-version 3 \
            --os-username testuser1 \
            --os-password testuser1_password \
            --os-auth-url http://10.0.0.6:35357/v3 \
            --os-project-name testproject1 \
            --os-project-domain-name ad \
            --os-user-domain-name ad \
            token issue
+------------+------------------------------------------------------------------+
| Field      | Value                                                            |
+------------+------------------------------------------------------------------+
| expires    | 2015-09-09T21:50:49.945893Z                                      |
| id         | 328e18486f69441fb13f4842423f52d1                                 |
| project_id | d065394842d34abd87167ab12759f107                                 |
| user_id    | e6d8c90abdc4510621271b73cc4dda8bc6009f263e421d8735d5f850f002f607 |
+------------+------------------------------------------------------------------+</pre>

        </li>




      </ol>

    </div>

    <div class="section" id="topic_ifg_n33_bt__encrypt"><h2 class="title sectiontitle">Transport Layer Security (TLS) Support</h2>
      <p class="p"> The Identity service supports various encryption options when an external LDAP or
        Microsoft Active Directory is configured for external authentication including: </p>

      <ul class="ul">
        <li class="li">External authentication with LDAP and Microsoft Active Directory systems</li>

        <li class="li">LDAPS specific support</li>

        <li class="li">STARTTLS</li>


      </ul>

    </div>


    
  </div>

<div class="navfooter"><!----></div><div class="footer">WebHelp output generated by<a class="oxyFooter" href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="../../oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a></div>
</body>
</html>