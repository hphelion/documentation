
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="The process for removing a compute node requires that you run these steps. Note that to run any playbooks whatsoever for cloud maintenance, you will always run from the deployer/lifecycle-manager ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="DC.Type" content="topic"></meta><meta name="DC.Title" content="HPE Helion OpenStack 2.0: Removing a Compute Node"></meta><meta name="prodname" content="HPE Helion"></meta><meta name="version" content="4.1.0"></meta><meta name="copyright" content="HPE Helion 2015" type="primary"></meta><meta name="DC.Rights.Owner" content="HPE Helion 2015" type="primary"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="topic_fld_zzy_lt"></meta><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>HPE Helion OpenStack 2.0: Removing a Compute Node</title><!--  Generated with Oxygen version 17.0, build number 2015072912.  --><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="../../oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "../../index.html";
          
          --></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="../../oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="../../oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="topic_fld_zzy_lt">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"></td><td><div class="navheader"></div></td></tr></tbody></table>

  <h1 class="title topictitle1">HPE Helion OpenStack<sup>Â®</sup> 2.0: Removing a Compute Node</h1>

  <div class="body">
  <div class="section" id="topic_fld_zzy_lt__removeNodes"> The process for removing a compute node requires that you run these
      steps. Note that to run any playbooks whatsoever for cloud maintenance, you will always run
      from the deployer/lifecycle-manager node.<ol class="ol">
        <li class="li">Disable provisioning to prevent new instances from being created on this node. </li>

        <li class="li">If possible migrate any instances on the node to other nodes. </li>

        <li class="li">Shut down the node or stop the nova-compute service. </li>

        <li class="li">Delete the compute node from nova </li>

        <li class="li">Amend servers.yml in the cloud configuration to remove entry for this node, commit the
          change and re run the config processor </li>

        <li class="li">Remove the node from cobbler</li>

        <li class="li">If you have availability zones configured, first remove nodes in availability zones
          steps first.</li>

      </ol>

    </div>

    
    <div class="section" id="topic_fld_zzy_lt__removeAZ"><h2 class="title sectiontitle">Remove Hosts from Host Aggregates</h2> When removing a compute
      node, if availability zones have been configured, either manually or using the Nova playbook
      <strong class="ph b">nova-cloud-configure.yml</strong>, or you have manually configured any host aggregates, then before
      executing the <samp class="ph codeph">service-delete</samp> command you need to remove the host(s) being deleted from any
      host aggregates. For example: <ol class="ol">
        <li class="li">Disable the
          service<pre class="pre codeblock">stack@padawan-ccp-c0-m1-mgmt:~$ nova service-disable --reason="HNOV-240 - removed" padawan-ccp-comp0002-mgmt nova-compute</pre>
<pre class="pre codeblock">+---------------------------+--------------+----------+--------------------+
| Host                      | Binary       | Status   | Disabled Reason    |
+---------------------------+--------------+----------+--------------------+
| padawan-ccp-comp0002-mgmt | nova-compute | disabled | HNOV-240 - removed |
+---------------------------+--------------+----------+--------------------+</pre>
</li>

        <li class="li">Get nova service
          list<pre class="pre codeblock">stack@padawan-ccp-c0-m1-mgmt:~$ nova service-list</pre>
<pre class="pre codeblock">+----+------------------+---------------------------+----------+----------+-------+----------------------------+--------------------+
| Id | Binary           | Host                      | Zone     | Status   | State | Updated_at                 | Disabled Reason    |
+----+------------------+---------------------------+----------+----------+-------+----------------------------+--------------------+
| 1  | nova-conductor   | padawan-ccp-c1-m1-mgmt    | internal | enabled  | up    | 2015-10-12T08:46:12.000000 | -                  |
| 4  | nova-scheduler   | padawan-ccp-c1-m1-mgmt    | internal | enabled  | up    | 2015-10-12T08:46:13.000000 | -                  |
| 7  | nova-conductor   | padawan-ccp-c1-m3-mgmt    | internal | enabled  | up    | 2015-10-12T08:46:14.000000 | -                  |
| 10 | nova-conductor   | padawan-ccp-c1-m2-mgmt    | internal | enabled  | up    | 2015-10-12T08:46:12.000000 | -                  |
| 13 | nova-scheduler   | padawan-ccp-c1-m3-mgmt    | internal | enabled  | up    | 2015-10-12T08:46:13.000000 | -                  |
| 16 | nova-consoleauth | padawan-ccp-c1-m1-mgmt    | internal | enabled  | up    | 2015-10-12T08:46:14.000000 | -                  |
| 19 | nova-scheduler   | padawan-ccp-c1-m2-mgmt    | internal | enabled  | up    | 2015-10-12T08:46:13.000000 | -                  |
| 22 | nova-compute     | padawan-ccp-comp0002-mgmt | AZ2      | disabled | up    | 2015-10-12T08:46:12.000000 | HNOV-240 - removed |
| 25 | nova-compute     | padawan-ccp-comp0001-mgmt | AZ1      | enabled  | up    | 2015-10-12T08:46:11.000000 | -                  |
| 28 | nova-compute     | padawan-ccp-comp0003-mgmt | AZ3      | enabled  | up    | 2015-10-12T08:46:11.000000 | -                  |
+----+------------------+---------------------------+----------+----------+-------+----------------------------+--------------------+</pre>
</li>

        <li class="li">Get availability
          zones<pre class="pre codeblock">stack@padawan-ccp-c0-m1-mgmt:~$ nova aggregate-list</pre>
<pre class="pre codeblock">+----+------+-------------------+
| Id | Name | Availability Zone |
+----+------+-------------------+
| 1  | AZ1  | AZ1               |
| 4  | AZ2  | AZ2               |
| 7  | AZ3  | AZ3               |
+----+------+-------------------+</pre>
</li>

        
        <li class="li">Check that the AZ has been
          removed:<pre class="pre codeblock">stack@padawan-ccp-c0-m1-mgmt:~$ nova aggregate-remove-host AZ2 padawan-ccp-comp0002-mgmt</pre>
<pre class="pre codeblock">Host padawan-ccp-comp0002-mgmt has been successfully removed from aggregate 4</pre>
<pre class="pre codeblock">+----+------+-------------------+-------+-------------------------+
| Id | Name | Availability Zone | Hosts | Metadata                |
+----+------+-------------------+-------+-------------------------+
| 4  | AZ2  | AZ2               |       | 'availability_zone=AZ2' |
+----+------+-------------------+-------+-------------------------+</pre>
</li>

        <li class="li">Get Availability Zone aggregate
          details<pre class="pre codeblock">stack@padawan-ccp-c0-m1-mgmt:~$ nova aggregate-details AZ2</pre>
<pre class="pre codeblock">+----+------+-------------------+-------+-------------------------+
| Id | Name | Availability Zone | Hosts | Metadata                |
+----+------+-------------------+-------+-------------------------+
| 4  | AZ2  | AZ2               |       | 'availability_zone=AZ2' |
+----+------+-------------------+-------+-------------------------+</pre>
</li>

        <li class="li">Delete service ID 22 (AZ2) and check that is deleted using <samp class="ph codeph">nova
          service-list</samp><pre class="pre codeblock">stack@padawan-ccp-c0-m1-mgmt:~$ nova service-delete 22
stack@padawan-ccp-c0-m1-mgmt:~$ nova service-list</pre>
<pre class="pre codeblock">+----+------------------+---------------------------+----------+---------+-------+----------------------------+-----------------+
| Id | Binary           | Host                      | Zone     | Status  | State | Updated_at                 | Disabled Reason |
+----+------------------+---------------------------+----------+---------+-------+----------------------------+-----------------+
| 1  | nova-conductor   | padawan-ccp-c1-m1-mgmt    | internal | enabled | up    | 2015-10-12T08:47:56.000000 | -               |
| 4  | nova-scheduler   | padawan-ccp-c1-m1-mgmt    | internal | enabled | up    | 2015-10-12T08:47:53.000000 | -               |
| 7  | nova-conductor   | padawan-ccp-c1-m3-mgmt    | internal | enabled | up    | 2015-10-12T08:47:54.000000 | -               |
| 10 | nova-conductor   | padawan-ccp-c1-m2-mgmt    | internal | enabled | up    | 2015-10-12T08:47:52.000000 | -               |
| 13 | nova-scheduler   | padawan-ccp-c1-m3-mgmt    | internal | enabled | up    | 2015-10-12T08:47:53.000000 | -               |
| 16 | nova-consoleauth | padawan-ccp-c1-m1-mgmt    | internal | enabled | up    | 2015-10-12T08:47:54.000000 | -               |
| 19 | nova-scheduler   | padawan-ccp-c1-m2-mgmt    | internal | enabled | up    | 2015-10-12T08:47:53.000000 | -               |
| 25 | nova-compute     | padawan-ccp-comp0001-mgmt | AZ1      | enabled | up    | 2015-10-12T08:47:51.000000 | -               |
| 28 | nova-compute     | padawan-ccp-comp0003-mgmt | AZ3      | enabled | up    | 2015-10-12T08:47:51.000000 | -               |
+----+------------------+---------------------------+----------+---------+-------+----------------------------+-----------------+</pre>

        </li>

      </ol>

    </div>

    <div class="section"><h2 class="title sectiontitle">Remove the Nodes</h2>
    <ol class="ol">
    <li class="li">For example, using a cloud administrator account first disable provisioning and then run
      <samp class="ph codeph">nova service-list</samp>
      <pre class="pre codeblock">~$ nova service-disable --reason="HNOV-240 - removed" hlm004-ccp-comp0004-mgmt nova-compute
~$ nova service-list</pre>

      to see the
      result<pre class="pre codeblock">+----+------------------+--------------------------+----------+----------+-------+----------------------------+--------------------+
| Id | Binary           | Host                     | Zone     | Status  | State | Updated_at | Disabled Reason |
+----+------------------+--------------------------+----------+----------+-------+----------------------------+--------------------+
...
| 40 | nova-compute     | hlm004-ccp-comp0005-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:53.000000 | -                  |
| 46 | nova-compute     | hlm004-ccp-comp0002-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:52.000000 | -                  |
| 49 | nova-compute     | hlm004-ccp-comp0006-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:53.000000 | -                  |
| 52 | nova-compute     | hlm004-ccp-comp0003-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:52.000000 | -                  |
| 55 | nova-compute     | hlm004-ccp-comp0001-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:56.000000 | -                  |
| 58 | nova-compute     | hlm004-ccp-comp0004-mgmt | nova     | disabled | up    | 2015-09-17T10:29:55.000000 | HNOV-240 - removed |
+----+------------------+--------------------------+----------+----------+-------+----------------------------+--------------------+</pre>

  </li>
<li class="li">    Next, run<pre class="pre codeblock">~$ nova list --host=hlm004-ccp-comp0004-mgmt --all_tenants=1</pre>

      to see all
      tenants<pre class="pre codeblock">+--------------------------------------+--------+----------------------------------+--------+------------+-------------+-----------------+
| ID                                   | Name   | Tenant ID                        | Status | Task State | Power State | Networks        |
+--------------------------------------+--------+----------------------------------+--------+------------+-------------+-----------------+
| 78fdb938-a89c-4a0c-a0d4-b88f1555c3b9 | paul4d | 5e9998f1b1824ea9a3b06ad142f09ca5 | ACTIVE | -          | Running     | paul=10.10.10.7 |
+--------------------------------------+--------+----------------------------------+--------+------------+-------------+-----------------+</pre>

    </li>
<li class="li"> Now, perform the
          migration:<pre class="pre codeblock">~$ nova live-migration --block-migrate 78fdb938-a89c-4a0c-a0d4-b88f1555c3b9
~$ nova list --host=hlm004-ccp-comp0004-mgmt --all_tenants=1</pre>

          and run nova list (above) to get the
          status:<pre class="pre codeblock">+--------------------------------------+--------+----------------------------------+-----------+------------+-------------+-----------------+
| ID                                   | Name   | Tenant ID                        | Status    | Task State | Power State | Networks        |
+--------------------------------------+--------+----------------------------------+-----------+------------+-------------+-----------------+
| 78fdb938-a89c-4a0c-a0d4-b88f1555c3b9 | paul4d | 5e9998f1b1824ea9a3b06ad142f09ca5 | MIGRATING | migrating  | Running     | paul=10.10.10.7 |
+--------------------------------------+--------+----------------------------------+-----------+------------+-------------+-----------------+</pre>

        </li>
<li class="li"> Run nova list again
          <pre class="pre codeblock">~$ nova list --host=hlm004-ccp-comp0004-mgmt --all_tenants=1</pre>
 to see
          that the running instance has been
          migrated:<pre class="pre codeblock">+----+------+-----------+--------+------------+-------------+----------+
| ID | Name | Tenant ID | Status | Task State | Power State | Networks |
+----+------+-----------+--------+------------+-------------+----------+
+----+------+-----------+--------+------------+-------------+----------+</pre>

        </li>
<li class="li"> Log into the compute node and stop the nova service 
          <div class="note note"><span class="notetitle">Note:</span> Before proceeding, you may want to take a look at <strong class="ph b">info/server_info.yml</strong> to see
            if the assignment of the node you have added is what you expect. It may not be, as nodes
            will not be numbered consecutively if any have previously been removed. This is to
            prevent loss of data; the config processor retains data about removed nodes and keeps
            their ID numbers from being reallocated. See the <a class="xref" href="../input_model.html#input_model__persistedserverallocations">Persisted Server
              Allocations</a> section in HPE Helion OpenStack 2.0 Input Model for information on
            how this works.</div>

          <pre class="pre codeblock">~$ ssh stack@hlm004-ccp-comp0004-mgmt "sudo systemctl stop nova-compute"</pre>

          or shut down the node. (alternatively, you may re-image the
          node):<pre class="pre codeblock">~$ ssh stack@hlm004-ccp-comp0004-mgmt "sudo shutdown now"</pre>
Alternatively,
          from the deployer, run the <strong class="ph b">bm-power-down.yml </strong>playbook <pre class="pre codeblock">~$ cd ~/helion/hos/ansible
    ~/helion/hos/ansible$ ansible-playbook -i hosts/localhost bm-power-down.yml -e nodelist=cpn-0004</pre>

          <pre class="pre codeblock">PLAY [localhost] **************************************************************
    GATHERING FACTS *************************************************************** 
    ok: [localhost]
    TASK: [cobbler | get-nodelist | User-specified target list] ******************* 
    ok: [localhost]
    TASK: [cobbler | get-nodelist | Check we have targets] ************************ 
    skipping: [localhost]
    TASK: [debug var=target_nodes] ************************************************ 
    ok: [localhost] =&gt; {
    "var": {
    "target_nodes": [
    "cpn-0004"
    ]
    }
    }
    TASK: [cobbler | power-down | Power the nodes down] *************************** 
    changed: [localhost] =&gt; (item=cpn-0004)
    PLAY RECAP ******************************************************************** 
    cobbler | power-down | Power the nodes down ----------------------------- 1.48s
    cobbler | get-nodelist | User-specified target list --------------------- 0.02s
    debug var=target_nodes -------------------------------------------------- 0.01s
    cobbler | get-nodelist | Check we have targets -------------------------- 0.01s
    -------------------------------------------------------------------------------
    Total: ------------------------------------------------------------------ 3.54s
    localhost : ok=4 changed=1 unreachable=0 failed=0</pre>

        </li>
<li class="li">Next, delete the nova compute node:
      <pre class="pre codeblock">~$ nova service-delete 58
~$ nova service-list</pre>
 And run nova
      service-list (above) to see that it s
      gone:<pre class="pre codeblock">+----+------------------+--------------------------+----------+----------+-------+----------------------------+--------------------+
| Id | Binary           | Host                     | Zone     | Status  | State | Updated_at | Disabled Reason |
+----+------------------+--------------------------+----------+----------+-------+----------------------------+--------------------+
...
| 40 | nova-compute     | hlm004-ccp-comp0005-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:53.000000 | -                  |
| 46 | nova-compute     | hlm004-ccp-comp0002-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:52.000000 | -                  |
| 49 | nova-compute     | hlm004-ccp-comp0006-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:53.000000 | -                  |
| 52 | nova-compute     | hlm004-ccp-comp0003-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:52.000000 | -                  |
| 55 | nova-compute     | hlm004-ccp-comp0001-mgmt | nova     | enabled  | up    | 2015-09-17T10:29:56.000000 | -                  |
+----+------------------+--------------------------+----------+----------+-------+----------------------------+--------------------+</pre>

      </li>
<li class="li">Then get hypervisor status:<pre class="pre codeblock">~$ nova hypervisor-list</pre>
 And check that the
      node has been removed from the
      list:<pre class="pre codeblock">+----+--------------------------+-------+---------+
| ID | Hypervisor hostname      | State | Status  |
+----+--------------------------+-------+---------+
| 1  | hlm004-ccp-comp0005-mgmt | up    | enabled |
| 7  | hlm004-ccp-comp0002-mgmt | up    | enabled |
| 10 | hlm004-ccp-comp0006-mgmt | up    | enabled |
| 13 | hlm004-ccp-comp0003-mgmt | up    | enabled |
| 16 | hlm004-ccp-comp0001-mgmt | up    | enabled |
+----+--------------------------+-------+---------+</pre>

      </li>
<li class="li">Then, on the deployer/lifecycle-manager node, remove the node from <strong class="ph b">servers.yml </strong><div class="note note"><span class="notetitle">Note:</span> Make
            sure you are removing the correct node from <strong class="ph b">servers.yml</strong> by ensuring you remove
            the stanza that contains the IP address that matches the node to be removed.</div>
 Edit
            <strong class="ph b">servers.yml </strong>to remove the entry for removed node.
          <pre class="pre codeblock">cd ~/helion/my_cloud/definition/data
git checkout site</pre>

        </li>
<li class="li">Then, commit the
        change, and rerun the config
        processor:
          <pre class="pre codeblock">git commit -a -m "Removed node &lt;name&gt;"
cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml
ansible-playbook -i hosts/localhost ready-deployment.yml</pre>

        </li>
<li class="li">There is no need to run the site.yml playbook. However you should remove the node from
      cobbler, as shown
      here:<pre class="pre codeblock">sudo cobbler system remove --name=&lt;node&gt;
ansible-playbook -i hosts/localhost cobbler-deploy.yml</pre>

      </li>
</ol>

    </div>

  
  </div>

<div class="navfooter"><!----></div><div class="footer">WebHelp output generated by<a class="oxyFooter" href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="../../oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a></div>
</body>
</html>